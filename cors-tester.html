<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tester Autentykacji JWT</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #3275e4;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Tester Autentykacji JWT</h1>
    <p>To narzędzie pozwala testować autentykację bazującą na JWT i pliki cookie.</p>
    
    <div>
        <h2>Test API</h2>
        <button id="checkApiHealth">Sprawdź API Health</button>
        <button id="checkAuthStatus">Sprawdź Status Autentykacji</button>
        <button id="refreshToken">Odśwież Token</button>
        <button id="deleteCookies">Usuń Ciasteczka</button>
    </div>
    
    <div class="result" id="apiResult">
        <h3>Wynik zapytania:</h3>
        <pre id="apiOutput">Naciśnij przycisk, aby wykonać test...</pre>
    </div>
    
    <div>
        <h2>Ciasteczka</h2>
        <button id="showCookies">Pokaż Ciasteczka</button>
        <button id="setTestCookie">Ustaw Testowe Ciasteczko</button>
    </div>
    
    <div class="result" id="cookieResult">
        <h3>Aktualne ciasteczka:</h3>
        <pre id="cookieOutput">Naciśnij przycisk, aby zobaczyć ciasteczka...</pre>
    </div>
    
    <script>
        // Konfiguracja
        const API_BASE_URL = 'http://localhost:5000';
        
        // Pomocnicze funkcje
        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }
        
        function setResultStatus(isSuccess, message) {
            const output = document.getElementById('apiOutput');
            output.textContent = message;
            document.getElementById('apiResult').className = `result ${isSuccess ? 'success' : 'error'}`;
        }
        
        function setCookieOutput(text) {
            document.getElementById('cookieOutput').textContent = text;
        }
        
        // Event listeners
        document.getElementById('checkApiHealth').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                setResultStatus(true, formatJSON(data));
            } catch (error) {
                setResultStatus(false, `Błąd: ${error.message}`);
            }
        });
        
        document.getElementById('checkAuthStatus').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/api/debug/auth-state`, {
                    credentials: 'include'
                });
                const data = await response.json();
                setResultStatus(response.ok, formatJSON(data));
            } catch (error) {
                setResultStatus(false, `Błąd: ${error.message}`);
            }
        });
        
        document.getElementById('refreshToken').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/api/token/refresh`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    setResultStatus(true, `Token odświeżony pomyślnie: ${formatJSON(data)}`);
                } else {
                    const errorText = await response.text();
                    setResultStatus(false, `Błąd odświeżania tokenu (${response.status}): ${errorText}`);
                }
            } catch (error) {
                setResultStatus(false, `Błąd: ${error.message}`);
            }
        });
        
        document.getElementById('showCookies').addEventListener('click', () => {
            const cookies = document.cookie.split(';')
                .map(cookie => cookie.trim())
                .reduce((obj, cookie) => {
                    if (cookie) {
                        const [name, value] = cookie.split('=');
                        return { ...obj, [name]: value };
                    }
                    return obj;
                }, {});
            
            setCookieOutput(formatJSON(cookies));
        });
        
        document.getElementById('setTestCookie').addEventListener('click', () => {
            const expires = new Date();
            expires.setTime(expires.getTime() + 3600 * 1000); // 1 hour
            
            document.cookie = `test_cookie=${Date.now()}; path=/; expires=${expires.toUTCString()}; SameSite=None; Secure`;
            document.cookie = `visible_auth=true; path=/; expires=${expires.toUTCString()}; SameSite=None; Secure`;
            
            setCookieOutput('Testowe ciasteczka ustawione. Kliknij "Pokaż Ciasteczka" aby zobaczyć rezultat.');
        });
        
        document.getElementById('deleteCookies').addEventListener('click', () => {
            // Lista ciasteczek do usunięcia
            const cookiesToDelete = [
                'access_token_cookie',
                'refresh_token_cookie',
                'auth_success',
                'visible_auth',
                'test_visible_cookie',
                'test_cookie'
            ];
            
            // Usuwanie ciasteczek przez ustawienie daty wygaśnięcia w przeszłości
            cookiesToDelete.forEach(name => {
                document.cookie = `${name}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=None; Secure`;
            });
            
            setResultStatus(true, 'Wszystkie ciasteczka autentykacji zostały usunięte.');
            setCookieOutput('Ciasteczka usunięte. Kliknij "Pokaż Ciasteczka" aby zweryfikować.');
        });
    </script>
</body>
</html>
