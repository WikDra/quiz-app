<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Cookie Diagnostics</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #4285F4;
        }
        .panel {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        #cookie-status {
            background-color: #333;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            opacity: 0.9;
        }
        .blue { background-color: #4285F4; }
        .green { background-color: #0F9D58; }
        .red { background-color: #DB4437; }
        .yellow { background-color: #F4B400; }
        .gray { background-color: #666; }
    </style>
</head>
<body>
    <h1>Browser Cookie Diagnostics</h1>
    
    <div class="panel">
        <h2>Cookie Status</h2>
        <div id="cookie-status">Loading cookie information...</div>
        
        <div class="btn-group">
            <button class="blue" id="check-cookies">Check Cookies</button>
            <button class="green" id="set-js-cookie">Set JS Cookie</button>
            <button class="red" id="set-server-cookie">Set Server Cookie</button>
            <button class="yellow" id="test-api">Test API</button>
            <button class="gray" id="clear-cookies">Clear Cookies</button>
        </div>
    </div>
    
    <div class="panel">
        <h2>Debug Information</h2>
        <p>This page helps diagnose cookie issues in cross-origin environments.</p>
        <ul>
            <li><strong>HttpOnly Cookies</strong>: Not visible to JavaScript, but sent with requests</li>
            <li><strong>SameSite=None</strong>: Required for cross-origin cookies, must be paired with Secure</li>
            <li><strong>Secure Flag</strong>: Requires HTTPS, may not work on localhost in some browsers</li>
            <li><strong>Cross-Origin Cookies</strong>: Must use credentials='include' for fetch/XHR</li>
        </ul>
    </div>
    
    <script>
        // Configuration
        const API_URL = 'http://localhost:5000';
        
        // DOM elements
        const cookieStatus = document.getElementById('cookie-status');
        
        // Check all cookies and display them
        function checkCookies() {
            const cookies = document.cookie;
            const cookieList = cookies.split(';').map(c => c.trim()).filter(c => c);
            
            let output = `Total cookies: ${cookieList.length}\n\n`;
            
            if (cookieList.length > 0) {
                output += "Client-visible cookies:\n";
                cookieList.forEach(cookie => {
                    output += `- ${cookie}\n`;
                });
            } else {
                output += "No client-visible cookies found!\n";
            }
            
            // Additional check for auth_success cookie
            const hasAuthSuccess = cookies.includes('auth_success');
            output += `\nauth_success cookie: ${hasAuthSuccess ? 'Present ✓' : 'Missing ✗'}\n`;
            
            cookieStatus.textContent = output;
        }
        
        // Set cookies using JavaScript
        function setJSCookies() {
            try {
                // Generate timestamp for unique value
                const timestamp = new Date().toISOString().slice(11, 19).replace(/:/g, '');
                
                // Create expiration date (1 hour from now)
                const expires = new Date();
                expires.setTime(expires.getTime() + 3600 * 1000);
                
                // Set standard cookie
                document.cookie = `js_test_cookie=${timestamp}; path=/; expires=${expires.toUTCString()}`;
                
                // Set auth_success cookie
                document.cookie = `auth_success=true; path=/; expires=${expires.toUTCString()}`;
                
                // Try setting a SameSite=None cookie (requires Secure in proper contexts)
                try {
                    document.cookie = `js_secure_cookie=${timestamp}; path=/; expires=${expires.toUTCString()}; SameSite=None; Secure`;
                } catch (e) {
                    console.warn('Could not set SameSite=None cookie:', e);
                }
                
                cookieStatus.textContent = `Set JavaScript cookies at ${timestamp}\n\nChecking cookies again...`;
                setTimeout(checkCookies, 100);
            } catch (error) {
                cookieStatus.textContent = `Error setting cookies: ${error.message}`;
                console.error('Cookie error:', error);
            }
        }
        
        // Set cookies via server
        async function setServerCookies() {
            try {
                cookieStatus.textContent = 'Requesting cookies from server...';
                
                const response = await fetch(`${API_URL}/api/debug/set-visible-cookie`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    cookieStatus.textContent = `Server response: Success\n\nChecking for cookies...`;
                    setTimeout(checkCookies, 200);
                } else {
                    cookieStatus.textContent = `Server error: ${response.status} ${response.statusText}\n\n${await response.text()}`;
                }
            } catch (error) {
                cookieStatus.textContent = `Error: ${error.message}`;
                console.error('Server request error:', error);
            }
        }
        
        // Test the API with credentials
        async function testApi() {
            try {
                cookieStatus.textContent = 'Testing API with credentials...';
                
                const response = await fetch(`${API_URL}/api/test-auth-cookies`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    let output = 'API Response:\n\n';
                    output += `JWT valid: ${data.jwt_valid ? 'Yes ✓' : 'No ✗'}\n`;
                    output += `User ID: ${data.user_id || 'None'}\n`;
                    
                    if (data.cookies) {
                        output += `\nServer-side cookies (${Object.keys(data.cookies).length}):\n`;
                        for (const [name, value] of Object.entries(data.cookies)) {
                            output += `- ${name}: ${value}\n`;
                        }
                    }
                    
                    if (data.error) {
                        output += `\nError: ${data.error}\n`;
                    }
                    
                    cookieStatus.textContent = output;
                } else {
                    cookieStatus.textContent = `API error: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                cookieStatus.textContent = `Error: ${error.message}`;
                console.error('API test error:', error);
            }
        }
        
        // Clear all cookies
        function clearCookies() {
            const cookies = document.cookie.split(';');
            
            if (cookies.length === 0) {
                cookieStatus.textContent = 'No cookies to clear';
                return;
            }
            
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i];
                const eqPos = cookie.indexOf('=');
                const name = eqPos > -1 ? cookie.substring(0, eqPos).trim() : cookie.trim();
                document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/;`;
            }
            
            cookieStatus.textContent = 'All cookies have been cleared';
            
            // Verify
            setTimeout(checkCookies, 100);
        }
        
        // Add event listeners
        document.getElementById('check-cookies').addEventListener('click', checkCookies);
        document.getElementById('set-js-cookie').addEventListener('click', setJSCookies);
        document.getElementById('set-server-cookie').addEventListener('click', setServerCookies);
        document.getElementById('test-api').addEventListener('click', testApi);
        document.getElementById('clear-cookies').addEventListener('click', clearCookies);
        
        // Check cookies on page load
        checkCookies();
    </script>
</body>
</html>
