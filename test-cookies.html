<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie Tester</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        h1 {
            color: #333;
        }
        button {
            background: #4285F4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #3367D6;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #cookieReadout {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Cookie Tester Tool</h1>
    
    <div class="card">
        <h2>Client-Side Cookies</h2>
        <div class="button-group">
            <button onclick="setClientCookie('test_cookie', 'value', { secure: true, sameSite: 'None' })">
                Set Secure Cookie
            </button>
            <button onclick="setClientCookie('test_cookie', 'value', { secure: false, sameSite: 'Lax' })">
                Set Regular Cookie
            </button>
            <button onclick="readClientCookies()">
                Read All Cookies
            </button>
            <button onclick="deleteClientCookie('test_cookie')">
                Delete Test Cookie
            </button>
        </div>
    </div>

    <div class="card">
        <h2>Server Interaction</h2>
        <div class="button-group">
            <button onclick="testApiCookies()">
                Test API Cookies
            </button>
            <button onclick="refreshToken()">
                Refresh Token
            </button>
            <button onclick="testCorsEndpoint()">
                Test CORS
            </button>
            <button onclick="testDebugAuth()">
                Show Auth Debug
            </button>
        </div>
    </div>

    <div class="card">
        <h2>Auth Tests</h2>
        <div class="button-group">
            <button onclick="setAuthSuccessCookie()">
                Set Auth Success Cookie
            </button>
            <button onclick="checkAuthSuccessCookie()">
                Check Auth Success Cookie
            </button>
            <button onclick="window.location.href = '/api/oauth/google'">
                Google Login
            </button>
        </div>
    </div>

    <div id="cookieReadout" class="card">
        <h2>Cookie Information</h2>
        <pre id="cookieOutput">No cookies read yet</pre>
    </div>

    <script>
        // Base URL - change this to match your backend
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:5000' 
            : '';

        // Set a client-side cookie with specified options
        function setClientCookie(name, value, options = {}) {
            const { secure = false, sameSite = 'Lax', maxAge = 3600 } = options;
            
            let cookieStr = `${name}=${encodeURIComponent(value)}; path=/`;
            
            if (secure) cookieStr += '; Secure';
            if (sameSite) cookieStr += `; SameSite=${sameSite}`;
            
            const expires = new Date();
            expires.setTime(expires.getTime() + maxAge * 1000);
            cookieStr += `; expires=${expires.toUTCString()}`;
            
            try {
                document.cookie = cookieStr;
                console.log('Set cookie:', cookieStr);
                readClientCookies();
                return true;
            } catch (error) {
                console.error('Error setting cookie:', error);
                document.getElementById('cookieOutput').textContent = `Error setting cookie: ${error.message}`;
                return false;
            }
        }

        // Read all client-side cookies
        function readClientCookies() {
            const cookies = {};
            
            if (document.cookie) {
                document.cookie.split(';').forEach(cookie => {
                    const [name, value] = cookie.trim().split('=');
                    cookies[name] = decodeURIComponent(value);
                });
            }
            
            const output = {
                count: Object.keys(cookies).length,
                cookies: cookies,
                raw: document.cookie
            };
            
            document.getElementById('cookieOutput').textContent = JSON.stringify(output, null, 2);
            console.log('Cookies:', output);
            return cookies;
        }

        // Delete a client-side cookie
        function deleteClientCookie(name) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            readClientCookies();
        }

        // Check for auth_success cookie
        function checkAuthSuccessCookie() {
            const cookies = readClientCookies();
            const hasAuthSuccess = cookies['auth_success'] === 'true';
            
            document.getElementById('cookieOutput').textContent = 
                `Auth Success Cookie: ${hasAuthSuccess ? 'Present' : 'Missing'}\n\n` + 
                JSON.stringify(cookies, null, 2);
        }

        // Set auth_success cookie
        function setAuthSuccessCookie() {
            setClientCookie('auth_success', 'true', { 
                secure: true, 
                sameSite: 'None',
                maxAge: 3600 // 1 hour
            });
        }

        // Test API cookies
        async function testApiCookies() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/test-auth-cookies`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                document.getElementById('cookieOutput').textContent = 
                    `API Response:\n${JSON.stringify(data, null, 2)}\n\nClient Cookies:\n` + 
                    document.cookie;
                    
                console.log('API response:', data);
            } catch (error) {
                console.error('API error:', error);
                document.getElementById('cookieOutput').textContent = `API Error: ${error.message}`;
            }
        }

        // Refresh JWT token
        async function refreshToken() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/token/refresh`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('cookieOutput').textContent = 
                        `Token Refreshed:\n${JSON.stringify(data, null, 2)}`;
                    console.log('Token refreshed:', data);
                } else {
                    document.getElementById('cookieOutput').textContent = 
                        `Token Refresh Failed: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                console.error('Refresh error:', error);
                document.getElementById('cookieOutput').textContent = `Refresh Error: ${error.message}`;
            }
        }

        // Test CORS configuration
        async function testCorsEndpoint() {
            try {
                // First make an OPTIONS request to check CORS headers
                const headers = await fetch(`${API_BASE_URL}/api/test-auth-cookies`, {
                    method: 'OPTIONS',
                    credentials: 'include'
                });
                
                // Now make the actual GET request
                const response = await fetch(`${API_BASE_URL}/api/test-auth-cookies`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                // Get response headers (limited by CORS)
                const corsHeaders = {};
                for (const header of ['access-control-allow-origin', 'access-control-allow-credentials',
                                     'access-control-allow-methods', 'access-control-allow-headers']) {
                    corsHeaders[header] = response.headers.get(header);
                }
                
                document.getElementById('cookieOutput').textContent = 
                    `CORS Headers:\n${JSON.stringify(corsHeaders, null, 2)}\n\nResponse:\n` +
                    JSON.stringify(data, null, 2);
                    
                console.log('CORS test:', corsHeaders, data);
            } catch (error) {
                console.error('CORS error:', error);
                document.getElementById('cookieOutput').textContent = `CORS Error: ${error.message}`;
            }
        }

        // Test debug auth endpoint
        async function testDebugAuth() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/debug/auth`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('cookieOutput').textContent = JSON.stringify(data, null, 2);
                    console.log('Debug auth:', data);
                } else {
                    document.getElementById('cookieOutput').textContent = 
                        `Debug Auth Failed: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                console.error('Debug auth error:', error);
                document.getElementById('cookieOutput').textContent = `Debug Auth Error: ${error.message}`;
            }
        }

        // Initialize by reading cookies
        document.addEventListener('DOMContentLoaded', readClientCookies);
    </script>
</body>
</html>
