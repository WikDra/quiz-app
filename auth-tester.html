<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz App Auth Tester</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    .card {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 4px;
    }
    button {
      background-color: #4285F4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #357ae8;
    }
    .output {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
    }
    .status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.pending {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Quiz App Auth Tester</h1>
    
    <div class="card">
      <h2>Authentication Testing</h2>
      <p>Use the buttons below to test authentication functionality with the Quiz App API.</p>
      
      <button id="testCookies">Test Cookies</button>
      <button id="debugAuth">Debug Auth Status</button>
      <button id="loginGoogle">Login with Google</button>
      <button id="checkProfile">Check Profile</button>
      <button id="logout">Logout</button>
    </div>
    
    <div class="card">
      <h2>Test Output</h2>
      <div id="output" class="output"></div>
    </div>
    
    <div id="status" class="status pending">
      Waiting for tests...
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE_URL = 'http://localhost:5000';
    const outputEl = document.getElementById('output');
    const statusEl = document.getElementById('status');
    
    // Helper function to log to output
    function log(message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      
      if (data) {
        console.log(message, data);
        let formattedData = '';
        try {
          formattedData = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        } catch (e) {
          formattedData = '[Object cannot be stringified]';
        }
        outputEl.innerHTML += `[${timestamp}] ${message}\n${formattedData}\n\n`;
      } else {
        console.log(message);
        outputEl.innerHTML += `[${timestamp}] ${message}\n\n`;
      }
      
      outputEl.scrollTop = outputEl.scrollHeight;
    }
    
    // Set status display
    function setStatus(type, message) {
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
    }
    
    // Test cookies
    document.getElementById('testCookies').addEventListener('click', async () => {
      log('Testing Cookies...');
      setStatus('pending', 'Testing cookies...');
      
      try {
        // First log existing cookies
        log('Current cookies:', document.cookie || '(none)');
        
        // Try to set a test cookie via the API
        const response = await fetch(`${API_BASE_URL}/api/test-cookies`, {
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const data = await response.json();
          log('Test cookie response:', data);
          
          // Check if cookie was set
          setTimeout(() => {
            log('After test, cookies:', document.cookie || '(none)');
            
            if (document.cookie.includes('test_cookie')) {
              setStatus('success', 'Test cookie was successfully set!');
            } else {
              setStatus('error', 'Test cookie was not set. Check browser cookie settings.');
              log('⚠️ IMPORTANT: If no cookie was set, you may need to adjust your browser settings to allow third-party cookies.');
            }
          }, 500);
        } else {
          const errorText = await response.text();
          log('Error testing cookies:', errorText);
          setStatus('error', 'Failed to test cookies');
        }
      } catch (error) {
        log('Error:', error.message);
        setStatus('error', `Error: ${error.message}`);
      }
    });
    
    // Debug auth
    document.getElementById('debugAuth').addEventListener('click', async () => {
      log('Checking auth debug...');
      setStatus('pending', 'Checking auth status...');
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/debug/auth`, {
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const data = await response.json();
          log('Auth debug info:', data);
          
          if (data.jwt_identity) {
            setStatus('success', `Authenticated as user ID: ${data.jwt_identity}`);
          } else {
            setStatus('error', 'Not authenticated');
          }
        } else {
          const errorText = await response.text();
          log('Error getting auth debug:', errorText);
          setStatus('error', 'Failed to check auth status');
        }
      } catch (error) {
        log('Error:', error.message);
        setStatus('error', `Error: ${error.message}`);
      }
    });
    
    // Google login
    document.getElementById('loginGoogle').addEventListener('click', () => {
      log('Opening Google login window...');
      setStatus('pending', 'Authenticating with Google...');
      
      const loginWindow = window.open(
        `${API_BASE_URL}/api/login/google`,
        'google-login',
        'width=600,height=700'
      );
      
      // Poll for window closure
      const checkClosure = setInterval(() => {
        if (loginWindow.closed) {
          clearInterval(checkClosure);
          log('Login window closed');
          
          // Wait a bit for cookies to be processed
          setTimeout(async () => {
            log('Checking if login was successful...');
            log('Cookies after login:', document.cookie || '(none)');
            
            try {
              const response = await fetch(`${API_BASE_URL}/api/users/me/profile`, {
                credentials: 'include'
              });
              
              if (response.ok) {
                const userData = await response.json();
                log('User profile data:', userData);
                setStatus('success', `Authenticated as: ${userData.username || userData.email}`);
              } else {
                log('Failed to get profile after login');
                setStatus('error', 'Login may have failed');
              }
            } catch (error) {
              log('Error checking login status:', error.message);
              setStatus('error', `Error: ${error.message}`);
            }
          }, 1000);
        }
      }, 500);
    });
    
    // Check profile
    document.getElementById('checkProfile').addEventListener('click', async () => {
      log('Checking user profile...');
      setStatus('pending', 'Getting user profile...');
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/users/me/profile`, {
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const data = await response.json();
          log('User profile:', data);
          setStatus('success', `Retrieved profile for: ${data.username || data.email}`);
        } else {
          const errorText = await response.text();
          log('Error getting profile:', errorText);
          setStatus('error', 'Failed to get profile - not authenticated');
        }
      } catch (error) {
        log('Error:', error.message);
        setStatus('error', `Error: ${error.message}`);
      }
    });
    
    // Logout
    document.getElementById('logout').addEventListener('click', async () => {
      log('Logging out...');
      setStatus('pending', 'Logging out...');
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/logout`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          log('Logout successful');
          setStatus('success', 'Logged out successfully');
          setTimeout(() => {
            log('Cookies after logout:', document.cookie || '(none)');
          }, 500);
        } else {
          const errorText = await response.text();
          log('Error logging out:', errorText);
          setStatus('error', 'Failed to logout');
        }
      } catch (error) {
        log('Error:', error.message);
        setStatus('error', `Error: ${error.message}`);
      }
    });
    
    // Init
    window.addEventListener('load', () => {
      log('Auth Tester initialized');
      log('API URL:', API_BASE_URL);
      log('Current cookies:', document.cookie || '(none)');
    });
  </script>
</body>
</html>
